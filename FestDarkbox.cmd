#REQUIRE Advance.cmd
#REQUIRE Cast.cmd
#REQUIRE ClearHand.cmd
#REQUIRE Error.cmd
#REQUIRE Face.cmd
#REQUIRE FestCastDevour.cmd
#REQUIRE Get.cmd
#REQUIRE Give.cmd
#REQUIRE Gouge.cmd
#REQUIRE Harness.cmd
#REQUIRE Information.cmd
#REQUIRE Inventory.cmd
#REQUIRE Loot.cmd
#REQUIRE Navigate.cmd
#REQUIRE Nounify.cmd
#REQUIRE Prepare.cmd
#REQUIRE Put.cmd
#REQUIRE Region.cmd
#REQUIRE Send.cmd
#REQUIRE Stand.cmd
#REQUIRE Stow.cmd
#REQUIRE Trash.cmd
#REQUIRE Travel.cmd
#REQUIRE WaitSpelltime.cmd
#REQUIRE Warning.cmd

# Without warning, the Darkbox simply vanishes.

var FestDarkbox.junkList some cebi root|some hisan flowers|some jadice flowers|some yelith root|a cougar-bone stack|a crocodile-bone stack|a frog-bone stack|some ape-pelt leather|some blood wolf pelt leather|some brown-scale leather|some green-scale leather|some reaver-pelt leather|some seal-pelt leather|some white fox pelt leather|a silver-etched skinning knife with an black-leucro hide wrapped hilt|a spiked axe inlaid along the blade with corroded bronze|a steel bodice dagger with a cherrywood hilt|a steel bodice dagger with a driftwood hilt|a thin steel dagger etched with the insignia of the Barbarians' Guild|a thin steel dagger etched with the insignia of the Empaths' Guild|a thin steel dagger etched with the insignia of the Traders' Guild|a beige knit woolen cap topped with a fuzzy fringe ball|a beige silk headscarf|a billowing wine-colored silk shirt with wide dagged sleeves|a black silk surcoat with the crest of the Bards' Guild on the front|a broad leather belt with wrought iron studs|a brown knit woolen cap topped with a fuzzy fringe ball|some brushed suede pants lined with brass rivets|some brushed suede pants lined with iron rivets|a charcoal grey lambswool cape embroidered with emerald green silk vines along the hemline|a cobalt-blue lambswool cape embroidered with tiny frogs along the hemline|a dark plum felt jacket with shiny silver buttons|a dusky rose damask ascot fastened with a silver pin|a deep red silk ascot fastened with a gold pin|an embossed leather belt with a gold-washed buckle|a fawn-brown leather belt decorated with steel studs in your grasp|a flamboyant crimson wizard's robe embroidered with golden stars|a floppy orange felt hat trimmed with a blue velvet band|a flowing pearl-grey silk sash embroidered with silver sigils|a flowing robe of pale lavender silk|a long-sleeved pale grey shirt with a row of buttons down the front|a low-slung pair of billowy sea-green gauze pants gathered close at the ankles|a mocha brown cloak lined with matching satin|a pair of slate-blue leather ankle boots decorated with copper chains|a pleated turquoise wool breeches cross-gartered from ankle to knee with pink silk cords|a red silk headscarf|a skullcap crafted of green silk with colorful beadwork|a skullcap crafted of indigo silk with colorful beadwork|a soft green linen trousers edged with black piping|a thick leather belt with steel studs|a white silk blouse with tiny black skeletons delicately embroidered on the cuffs|a white silk surcoat with the crest of the Barbarians' Guild on the front|a diopside-eyed cambrinth king snake|a quartz-eyed cambrinth coyote with its hackles raised|a ruby-eyed cambrinth viper|a sapphire-eyed cambrinth cobra|a simple cambrinth anklet|a spiraling cambrinth armband|a spiraling cambrinth armband painted with a kind-faced Halfling|a spiraling cambrinth armband painted with dancing cupcakes|a twisted cambrinth ring|a wavy cambrinth earcuff|a wavy cambrinth earcuff shaped like a coyote|a wavy cambrinth earcuff shaped like a donkey|a wavy cambrinth earcuff shaped like a ram|a brown leather eye patch|some bright green powder|some bright orange powder|a carved dove-shaped ocarina|a carved rabbit-shaped ocarina|some deep red powder|a gaily painted wooden quince|some green-white powder|some hazy mauve powder|some lightning blue powder|some ruby red powder|some yellow-gold powder|a whiskey-laced cigar|a beer-baked ham|a flagon of Gor'Tog bloodgrog|a grilled T-bone steak|a honey-glazed ham|a milk chocolate badger with currant eyes|a milk chocolate centaur with currant eyes|a milk chocolate dragon with currant eyes|a savory hickory-smoked ham|a ship's biscuit|a slice of silky white chocolate rum cheesecake|a Smatha Special ham|a spiced cheese crackers|some Yarrel's sun-dried jerky|a brown kelp|a dark brown kelp|a green kelp|a dark green kelp|a green-brown kelp|a brown rockweed|a dark brown rockweed|a green rockweed|a green-brown rockweed|a piece of bedraggled sharkskin|a piece of coarse sharkskin|a piece of decaying sharkskin|a piece of faded sharkskin|a piece of frayed sharkskin|a piece of glossy sharkskin|a piece of ragged sharkskin|a piece of ratty sharkskin|a piece of rent sharkskin|a piece of rough sharkskin|a piece of scruffy sharkskin|a piece of shabby sharkskin|a piece of smooth sharkskin|a piece of torn sharkskin|a piece of worn sharkskin|some.+burlap cloth|some.+cotton cloth|some.+linen cloth|some.+silk cloth|some.+wool cloth|a darkstone \w+|a electrum \w+|a lead \w+|a lumium \w+|a nickel \w+|a oravir \w+|a steel \w+|a zinc \w+|an alabaster \w+|a basalt \w+|a coal \w+|a dolomite \w+|a granite \w+|a limestone \w+|a marble \w+|a pumice \w+|a sandstone \w+|a schist \w+|a serpentine \w+|a travertine \w+|a tall bottle of turnip mash|some sluagh-hide boots with hammered steel heels|some reddish orange powder|a dark green rockweed|a milk chocolate cobra with currant eyes|a skullcap crafted of orange silk with colorful beadwork|a pink-plumed captain's hat of fine black felt|some deep violet powder|a black linen shirt with carved onyx buttons|a piece of dingy sharkskin|a green linen shirt with carved jade buttons|a flowing robe of pale yellow silk|a moonspun silk robe dyed dark purple with a sun-shaped golden clasp|a flamboyant purple wizard's robe embroidered with golden stars|a spiraling cambrinth armband painted with a beltunumshi|some blue-violet powder|some blue-grey powder|a low-slung pair of billowy blue-green gauze pants gathered close at the ankles|a chocolate caramel muffin|a blue-green wool cloak embroidered at the edges with elaborate silver knotwork|a yellow knit woolen cap topped with a fuzzy fringe ball|a tan knit woolen cap topped with a fuzzy fringe ball|a boar tusk necklace strung on a leather thong|a pair of blood red suede ankle boots|a billowing sky-blue silk shirt with wide dagged sleeves|a purple-plumed captain's hat of fine black felt|a flamboyant blue mage's robe appliqued with silver-spangled comets|an orange silk headscarf|some tenderfoot venison|a floppy grey felt hat trimmed with a black velvet band|a violet-red leather belt studded with tiny steel snowflakes|a milk chocolate frog with currant eyes|some soft mauve linen trousers edged with black piping|a skullcap crafted of crimson silk with colorful beadwork|a flamboyant crimson mage's robe appliqued with silver-spangled comets|a pair of nutmeg-brown leather ankle boots decorated with bronze chains|some goblin-hide pants|some bristleback spareribs|a floppy green felt hat trimmed with a yellow velvet band|a polished platinum mirror with enamelled webbing covering the back|some elaborately interwoven web-like platinum strands strung with tiny crystal beads

var FestDarkbox.keepList an infuser stone|a potency crystal|a bulging pouch|a small pouch|a blunt shark's tooth|a broken shark's tooth|a bumpy shark's tooth|a chipped shark's tooth|a cloven shark's tooth|a coarse shark's tooth|a cracked shark's tooth|a damaged shark's tooth|a dull shark's tooth|a flat shark's tooth|a fractured shark's tooth|a glossy shark's tooth|a knobby shark's tooth|a lustrous shark's tooth|a needle-thin shark's tooth|a nicked shark's tooth|a pierced shark's tooth|a polished shark's tooth|a ratty shark's tooth|a ridged shark's tooth|a riven shark's tooth|a rough shark's tooth|a sharp shark's tooth|a shiny shark's tooth|a smooth shark's tooth|a split shark's tooth|a torn shark's tooth|a wickedly serrated shark's tooth|some droluger-hide leather|a copper coin

action var FestDarkbox.currentPrize $1 when ^As you remove your hand from the Darkbox you see (.+) in your grasp\!$
action put #echo >Log white Item: $1 when ^You pick up (.+)\.$
action send stop play when ^You're already playing a song\!  You'll need to stop that one first\.$
# todo: gosub the 'play darkbox' command
var FestDarkbox.droppedItem
var FestDarkbox.haveTeeth 0
action var FestDarkbox.droppedItem $1 when ^Your (.+) falls to the ground\.$
#Your torn sharkskin falls to the ground.
gosub ClearHand both
if ("$SpellTimer.EyesoftheBlind.active" == "1") then gosub Release EOTB

if ("$zoneid" != "210") then {
	gosub Region
	if ("$region" != "Crossing") then gosub Travel 1
	gosub Navigate 1 fest
	gosub WaitEnterFest
}

Loop:
	if ("%FestDarkbox.droppedItem" != "") then {
		gosub Nounify %FestDarkbox.droppedItem
		gosub Get %Nounify.noun
		if (%Get.success != 1) then {
			# If I failed here I likely need to pause for healing.
			pause 20
			gosub Get %Nounify.noun
		}
		# Going to gosub PlayedDarkbox so we can determine if the retreived item is junk or not.
		gosub PlayedDarkbox
		var FestDarkbox.droppedItem 
	}
	# Clean-up section for grabbing stuff other players drop:
	if (matchre("$roomobjs", "\b(stone|tooth|crystal)\b")) then gosub Stow $1
	# Check for inability to stow items:
	if ("$righthand $lefthand" != "Empty Empty") then {
		put exit
		pause
		exit
	}
	if ("$SpellTimer.Devour.active" != "1") then {
		if (%FestDarkbox.haveTeeth == 1) then {
			gosub FestDarkboxTurnInTeeth
		}
		gosub FestCastDevour
	}
	if !contains("$roomobjs", "Darkbox") then gosub FindDarkbox
	gosub PlayDarkbox
	goto Loop

PlayDarkbox:
	var FestDarkbox.currentPrize 
	gosub Stand
	put play darkbox
	wait
PlayedDarkbox:
	if ("$lefthand $righthand" == "Empty Empty") then return
	if (!contains("$lefthand $righthand", "Empty")) then exit
	# Assumes we only have something in one hand.
	if ("$righthand" != "Empty") then {
		var FestDarkbox.itemID #$righthandid
		var FestDarkbox.itemDesc $righthand
		var FestDarkbox.itemNoun $righthandnoun
	}
	if ("$lefthand" != "Empty") then {
		var FestDarkbox.itemID #$lefthandid
		var FestDarkbox.itemDesc $lefthand
		var FestDarkbox.itemNoun $lefthandnoun
	}
	if (matchre("%FestDarkbox.junkList", "%FestDarkbox.currentPrize")) then {
		gosub Information Darkbox: junk - $righthand
		gosub Trash %FestDarkbox.itemID
		return
	}
	if (contains("coin|coins", "%FestDarkbox.itemNoun")) then {
		gosub Information Darkbox: coins.
		gosub Get my coin
		return
	}
	if (matchre("%FestDarkbox.itemDesc", "(small|bulging) pouch")) then {
		gosub Information Darkbox: tickets!
		gosub Open %FestDarkbox.itemID
		#gosub Get ticket from %FestDarkbox.itemID <- this was totally working for days and suddenly stopped...
		gosub Get ticket from my %FestDarkbox.itemDesc
		gosub Trash %FestDarkbox.itemID
		return
	}
	if ("%FestDarkbox.itemNoun" == "tooth") then {
		var FestDarkbox.haveTeeth 1
		gosub Information Darkbox: tooth.
		gosub Stow my tooth
		return
	}
	if (matchre("%FestDarkbox.keepList", "%FestDarkbox.currentPrize")) then {
		put #echo >Info Cyan Keeping item: %FestDarkbox.currentPrize
		gosub ClearHand both
		return
	}
	#Default action:
		#put #beep
		#put #flash
		gosub Warning Darkbox: new item - %FestDarkbox.itemDesc ( %FestDarkbox.itemID )
		gosub Stow %FestDarkbox.itemID
		return

FindDarkbox:
	if ("$darkboxroom" != "" && !contains("$darkboxroom", "$")) then gosub Navigate $zoneid $darkboxroom
	if (contains("$roomobjs", "Darkbox")) then return
	put .FestSearchFor Darkbox
	waiteval (contains("$roomobjs", "Darkbox"))
	pause .5
	return

FestDarkboxTurnInTeeth:
	gosub ClearHand both
	gosub Navigate 210 clearing
FestDarkboxTurningInTeeth:
	gosub Get my shark's tooth
	if ("%Get.success" == "0") then return
	gosub Give my shark's tooth to gnomish workman
	if ("%Give.success" == "0") then return
	goto FestDarkboxTurningInTeeth